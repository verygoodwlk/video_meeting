<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <base th:href="${#request.getContentType() + '/resources_webcon/'}"/>
    <meta charset="UTF-8">
    <title>实时音乐</title>
    <link href="css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
    <style>
        .btn-large-dim {
            width: 80px;
            height: 80px;
            font-size: 10px;
            margin-bottom: 0px;
        }

        /*.left_content1 {
            height: 300px;
        }

        .left_content2 {
            height: 300px;
        }

        .right_content {
            height: 600px;
        }*/
    </style>


    <!--引入webuploader-->
    <link rel="stylesheet" type="text/css" href="widget/webuploader/webuploader.css">
    <script type="text/javascript" src="widget/webuploader/webuploader.min.js"></script>
    <script type="text/javascript" src="myjs/upload.js"></script>

    <!-- 引入ztree -->
    <link rel="stylesheet" href="widget/zTree/zTreeStyle/zTreeStyle.css"/>
    <script type="text/javascript" src="widget/zTree/jquery.ztree.all.min.js"></script>
    <script type="text/javascript" src="myjs/tree.js"></script>

    <script type="text/javascript" src="myjs/task.js"></script>

    <!-- 数字选择插件-->
    <script type="text/javascript" src="widget/number/numberInput.js"></script>
    <script type="text/javascript" src="myjs/number.js"></script>


    <script th:inline="javascript">
        $(function () {
            //动态计算高度
            autoHeight();

            //初始化任务列表
            initTaskList();
        });

        /**
         * 初始化任务列表
         */
        var tasks;
        function initTaskList() {
            $.ajax({
                url: [[${#request.getContextPath()}]] + "/web/task/list",
                data: {"taskt": 5},
                success: function (data) {
                    if (data) {
                        tasks = data;
                        var html = "";
                        for (var i = 0; i < data.length; i++) {
                            html = realMusicHtml(data[i]);
                        }

                        $("#task_list").html(html);
                    }
                },
                dataType: "json"
            });
        }

        /**
         * 点击行
         */
        function trtask(taskid) {
            $("tr[id^='tr_task_']").css("background-color", "");
            $("tr[id^='tr_task_']").attr("alt", "");
            $("#tr_task_" + taskid).css("background-color", "#f1f1f1");
            $("#tr_task_" + taskid).attr("alt", "del");

            //根据任务id查询相应的任务
            $.get([[${#request.getContextPath()}]] + "/web/task/info", {"tid": taskid}, function(data){
                var mp3s = data.mp3;
                if(mp3s){
                    var html = "";
                    for(var i = 0; i < mp3s.length; i++){
                        html += "<tr><td><img src='icon/music.png'/> " + mp3s[i] + "</td></tr>";
                    }
                    $("#mp3_list").html(html);
                }

                var clients = data.clients;
                if(clients){
                    var html = "";
                    for(var i = 0; i < clients.length; i++){
                        if(clients[i] != null){
                            if(clients[i].status == 1){
                                //在线
                                html += "<tr><td><img src='resources/images/online2.png'/> " + clients[i].terminalname + "</td></tr>";
                            } else {
                                //不在线
                                html += "<tr><td><img src='resources/images/offline2.png'/> " + clients[i].terminalname + "</td></tr>";
                            }
                        }
                    }
                    $("#clients_list").html(html);
                }



                //获得类型
                var loopType = data.looptype;
                // $("input[type='radio'][name='looptype'][value='" + loopType + "']").attr("checked", true);
                var radio = document.getElementsByName("looptype");
                for(var i = 0; i < radio.length; i++){
                    if(radio[i].value == loopType){
                        radio[i].checked = true;
                        break;
                    }
                }

                //处理音量
                var volume = data.volume;
                $("#volume input").val(volume);

            }, "json");

        }


        /**
         * 删除任务
         */
        function delete_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要删除的任务！");
                return;
            }

            if(confirm("是否确认删除选中的任务？")){
                var tid = task.getAttribute("taskidstr");

                $.get([[${#request.getContextPath()}]] + "/web/task/delete", {"taskid":tid, "taskt":5}, function(data){
                    if(data > 0){
                        $("[alt='del']").remove();
                        $("#mp3_list").html("");
                        $("#clients_list").html("");
                    } else {
                        alert("删除失败！");
                    }
                },"text");


            }
        }

        /**
         * 拷贝任务
         */
        function copy_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要拷贝的任务！");
                return;
            }

            if(confirm("是否确认复制选中的任务？")){
                var tid = task.getAttribute("taskidstr");

                $.get([[${#request.getContextPath()}]] + "/web/task/copy", {"taskid":tid}, function(data){
                    if(data){
                        var html ="";
                        // html += "<tr id='tr_task_" + data.id + "' taskid='" + data.id + "' taskidstr='" + data.taskid + "' onclick='trtask(" + data.id + ");'>";
                        // html += "<td>" + data.taskname + "</td>";
                        // html += "<td>" + data.status + "</td>";
                        // html += "<td>" + data.duration + "</td>";
                        // html += "<td></td>";
                        // html += "</tr>";
                        html = realMusicHtml(data);

                        $("#task_list").append(html);
                    } else {
                        alert("复制失败！");
                    }
                },"json");
            }
        }

        /**
         * 手动执行
         */
        function action_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要执行的任务！");
                return;
            }

            // if(confirm("是否确认执行选中的任务？")){
                var tid = task.getAttribute("taskidstr");

                $.get([[${#request.getContextPath()}]] + "/web/task/action", {"taskid":tid}, function(data){
                    if(data){
                    } else {
                        alert("执行失败！");
                    }
                },"json");
            // }
        }

        /**
         * 手动暂停
         */
        function pause_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要暂停的任务！");
                return;
            }

            // if(confirm("是否确认暂停选中的任务？")){
                var tid = task.getAttribute("taskidstr");

                $.get([[${#request.getContextPath()}]] + "/web/task/pause", {"taskid":tid}, function(data){
                    if(data){
                    } else {
                        alert("暂停失败！");
                    }
                },"json");
            // }
        }

        /**
         * 手动停止
         */
        function stop_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要停止的任务！");
                return;
            }

            // if(confirm("是否确认停止选中的任务？")){
                var tid = task.getAttribute("taskidstr");

                $.get([[${#request.getContextPath()}]] + "/web/task/stop", {"taskid":tid}, function(data){
                    if(data){
                    } else {
                        alert("停止失败！");
                    }
                },"json");
            // }
        }

        /**
         * 上一曲
         */
        function pre_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要执行的任务！");
                return;
            }

            var tid = task.getAttribute("taskidstr");

            $.get([[${#request.getContextPath()}]] + "/web/task/pre", {"taskid":tid}, function(data){
                if(data){
                } else {
                    alert("执行上一曲失败！");
                }
            },"json");
        }

        /**
         * 下一曲
         */
        function next_task(){
            var task = $("[alt='del']")[0];
            if(!task){
                alert("请选中需要执行的任务！");
                return;
            }

            var tid = task.getAttribute("taskidstr");

            $.get([[${#request.getContextPath()}]] + "/web/task/next", {"taskid":tid}, function(data){
                if(data){
                } else {
                    alert("执行下一曲失败！");
                }
            },"json");
        }

    </script>

    <!-- 音量选择控件 -->
    <!--<link href="css/plugins/ionRangeSlider/ion.rangeSlider.css" rel="stylesheet">-->
    <!--<link href="css/plugins/ionRangeSlider/ion.rangeSlider.skinFlat.css" rel="stylesheet">-->
    <!--<script src="js/plugins/ionRangeSlider/ion.rangeSlider.min.js"></script>-->
    <!--<script>-->
        <!--$("#volume").ionRangeSlider({-->
            <!--min: 0,-->
            <!--max: 15,-->
            <!--from: 0,-->
            <!--postfix: "",-->
            <!--prettify: false,-->
            <!--hasGrid: false-->
        <!--});-->
    <!--</script>-->


</head>
<body>
<!-- 顶部 -->
<div class="row border-bottom white-bg dashboard-header myheader" style="padding: 10px 10px 10px 10px">


    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="open_Model();">
        <!-- data-toggle="modal" data-target="#myModal2" -->
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_newtask.png"/><br/>
        新建任务
    </button>
   <!-- <button class="btn btn-primary dim btn-large-dim" type="button" onclick="open_update_Model();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_edittask.png"/><br/>
        编辑任务
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="delete_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_deltask.png"/><br/>
        删除任务
    </button>-->
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="isAction(1);">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/dsyy_edittask.png"/><br/>
        编辑任务
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="isAction(2);">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/dsyy_deltask.png"/><br/>
        删除任务
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="copy_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_copytask.png"/><br/>
        复制任务
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="action_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_play.png"/><br/>
        手动执行
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="pause_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_pause.png"/><br/>
        手动暂停
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="stop_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_stop.png"/><br/>
        手动停止
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="pre_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_pre.png"/><br/>
        上一曲
    </button>
    <button class="btn btn-primary dim btn-large-dim" type="button" onclick="next_task();">
        <img style="width: 50px; height: 50px; margin-bottom: 5px" src="icon/ssyy_next.png"/><br/>
        下一曲
    </button>
</div>
<!-- 工作区 -->
<div class="animated fadeInRight">
    <div class="row">
        <div class="col-lg-5" style="padding: 2px 2px 2px 2px; margin-bottom: 2px;">
            <div class="ibox float-e-margins" style="margin-bottom: 2px">
                <div class="ibox-content left_content1 h_2">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title" style="border-width: 0px 0px 0px;">
                            <h5>曲目列表</h5>
                        </div>
                        <div class="ibox-content" style="height: 300px; overflow:scroll; overflow-y: auto; overflow-x: auto;">

                            <table class="table">
                                <tbody id="mp3_list">
                                    <!-- TODO 曲目列表 -->
                                </tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
            <div class="ibox float-e-margins">
                <div class="ibox-content left_content2 h_2">
                    <div class="ibox float-e-margins">
                        <div class="ibox-title" style="border-width: 0px 0px 0px;">
                            <h5>终端列表</h5>
                        </div>
                        <div class="ibox-content" style="height: 300px; overflow:scroll; overflow-y: auto; overflow-x: auto;">

                            <table class="table">
                                <!--<thead>
                                <tr>
                                    <th>#</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Username</th>
                                </tr>
                                </thead>-->
                                <tbody id="clients_list">
                                    <!-- TODO 终端列表 -->
                                </tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-7" style="padding: 2px 2px 2px 2px; margin-bottom: 2px;">
            <div class="ibox float-e-margins">
                <div class="ibox-content right_content h_1">


                    <div class="ibox-title" style="border-width: 0px 0px 0px;">
                        <label class="checkbox-inline">
                            <input type="radio" name="looptype" value="0" checked>
                            随机播放
                        </label>
                        <label class="checkbox-inline">
                            <input type="radio" name="looptype" value="1">
                            循环播放
                        </label>
                        <label class="checkbox-inline">
                            音量
                        </label>
                        <label class="checkbox-inline" style="width: 30%; margin-left: 0px; padding-left: 10px">
                            <!--<div id="volume"></div>-->
                            <div id="volume" class="mynumber" style="margin-bottom: 10px;"></div>
                        </label>
                        <label class="checkbox-inline">
                            <button type="button" class="btn btn-w-m btn-warning" onclick="update_task_volume();">修改</button>
                        </label>
                    </div>

                    <div class="ibox-content" style="padding-left: 0px; padding-right: 0px">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>任务标识</th>
                                <th>任务状态</th>
                                <th>持续时间</th>
                                <th>当前播放曲目</th>
                            </tr>
                            </thead>
                            <tbody id="task_list">
                            <!-- TODO 任务列表 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 弹出框 -->
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <!-- animated bounceInRight -->
        <!-- animated flipInY -->
        <div class="modal-content animated flipInY">
            <!-- 头部信息 -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">实时音乐</h4>
            </div>
            <!-- 内容部分 -->
            <div class="modal-body" style="padding: 0px">
                <div class="row" style="margin: 0px;">
                    <div class="col-lg-6" style="padding: 4px;">
                        <div class="ibox float-e-margins" style="margin-bottom: 0px">
                            <div class="ibox-content" style="position: relative; height: 500px;">
                                <!-- 音乐上传 -->
                                <div class="btns">
                                    <button id="picker" type="button" class="btn btn-w-m btn-info">选择文件</button>
                                    <button id="upload_btn" class="btn btn-w-m btn-primary" onclick="start_upload();">
                                        开始上传
                                    </button>
                                </div>
                                <div class="ibox-content"
                                     style="padding-left: 0px; padding-right: 0px; padding-top: 10px; height: 400px; overflow:scroll; overflow-y: auto; overflow-x: auto;">

                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th colspan="2">上传列表</th>
                                        </tr>
                                        </thead>
                                        <tbody id="upload_list">
                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <select id="loopType" class="form-control m-b" name="loopType">
                                        <option value="0">随机播放</option>
                                        <option value="1">循环播放</option>
                                    </select>
                                    <!--<label>
                                        <input type="radio" checked="checked" value="0" name="loopType">
                                        随机播放
                                    </label>
                                    <label style="margin-left: 20px">
                                        <input type="radio" checked="checked" value="1" name="loopType">
                                        循环播放
                                    </label>-->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6" style="padding: 4px">
                        <div class="ibox float-e-margins" style="margin-bottom: 0px">
                            <div class="ibox-content" style="height: 500px;">
                                <!-- 分控选择 -->
                                <form role="form" class="form-inline">
                                    <div class="form-group">
                                        <input type="text" placeholder="任务标识" id="taskname"
                                               class="form-control" style="width: 160px">
                                    </div>
                                    <div class="checkbox m-r-xs">
                                        <input type="checkbox" id="checkbox1" onclick="checkall(this.checked);">
                                        <label for="checkbox1">
                                            全选
                                        </label>
                                    </div>
                                </form>

                                <!-- 树形选择器 -->
                                <div id="ztree_div" class="ztree"
                                     style="height: 430px; overflow:scroll; overflow-y: auto; overflow-x: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 底部按钮 -->
            <div class="modal-footer">
                <button type="button" id="submitBtn" class="btn btn-primary" onclick="submit_task();">提交</button>
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    /**
     * 打开弹出框
     */
    function open_Model() {
        //初始化树形结构
        initClients();

        //重置上传
        resetUpload();

        //重置表单
        reset_Model(5);

        //显示弹出框
        // $("#myModal2").modal('show');
        $("#myModal2").modal({backdrop: 'static', keyboard: false});

        //延迟刷新上传控件
        setTimeout(function () {
            uploader.refresh();
        }, 500);

        //设置按钮的点击事件
        $("#submitBtn").attr("onclick", "submit_task();");

    }

    /**
     * 提交任务
     */
    function submit_task() {
        //获得任务名称
        taskname = $("#taskname").val();
        //获得循环类型
        var loopType = $("#loopType").val();

        //获得被选择的终端
        var znodes = ztreeObj.getCheckedNodes(true);
        terminal = [];
        for (var i = 0; i < znodes.length; i++) {
            if (znodes[i].isClient == 1) {
                //如果是终端
                terminal.push(znodes[i].userid);
            }
        }

        //表单验证
        if(!check_Form(5)){
            return;
        }

        // alert("任务名称：" + taskname);
        // alert("循环类型：" + loopType);
        // alert("终端列表：" + JSON.stringify(terminal));
        // alert("上传列表：" + JSON.stringify(files));

        //ajax提交任务
        $.ajax({
            type: "POST",
            url: [[${#request.getContextPath()}]] + '/web/task/insert',
            data: {
                "mp3": JSON.stringify(files),
                "users": JSON.stringify(terminal),
                "taskname": taskname,
                "looptype": loopType,
                "taskt": 5
            },
            success: function (data) {
                //发送websocket
                console.log(data);

                var html = "";
                html = realMusicHtml(data);
                // html += "<tr id='tr_task_" + data.id + "' taskid='" + data.id + "' taskidstr='" + data.taskid + "' onclick='trtask(" + data.id + ");'>";
                // html += "<td>" + data.taskname + "</td>";
                // html += "<td>空闲任务</td>";
                // html += "<td>" + data.duration + "</td>";
                // html += "<td></td>";
                // html += "</tr>";
                $("#task_list").append(html);

                //关闭弹窗
                $("#myModal2").modal("hide");
            },
            error: function (data) {
                alert("任务添加失败！");
            }
        });
    }

    /**
     * 弹出修改任务的弹出框
     */
    function open_update_Model(){
        var task = $("[alt='del']")[0];
        if(!task){
            alert("请选中需要编辑的任务！");
            return;
        }

        var tid = task.getAttribute("taskidstr");

        //弹出框
        open_Model();

        $.get([[${#request.getContextPath()}]] + "/web/task/queryTask", {"taskid":tid}, function(data){
            if(data){
                //设置默认值
                console.log(JSON.stringify(data));

                //回显数据
                showData(data, 5);
            }
        },"json");

        //设置按钮的点击事件
        $("#submitBtn").attr("onclick", "update_task('" + tid + "');");
    }

    //修改
    function update_task(tid){
        //获得任务名称
        var taskname = $("#taskname").val();

        //获得循环类型
        var loopType = $("#loopType").val();

        //获得被选择的终端
        var znodes = ztreeObj.getCheckedNodes(true);
        var terminal = [];
        for (var i = 0; i < znodes.length; i++) {
            if (znodes[i].isClient == 1) {
                //如果是终端
                terminal.push(znodes[i].userid);
            }
        }

        // alert("任务名称：" + taskname);
        // alert("循环类型：" + loopType);
        // alert("终端列表：" + JSON.stringify(terminal));
        // alert("上传列表：" + JSON.stringify(files));

        //ajax提交任务
        $.ajax({
            type: "POST",
            url: [[${#request.getContextPath()}]] + '/web/task/update',
            data: {
                "mp3": JSON.stringify(files),
                "users": JSON.stringify(terminal),
                "taskname": taskname,
                "looptype": loopType,
                "taskt": 5,
                "taskid": tid
            },
            success: function (data) {
                //发送websocket
                console.log(data);

                //移除原来的节点
                $("#tr_task_" + data.id).remove();

                var html = "";
                html = realMusicHtml(data);
               /* html += "<tr id='tr_task_" + data.id + "' taskid='" + data.id + "' taskidstr='" + data.taskid + "' onclick='trtask(" + data.id + ");'>";
                html += "<td>" + data.taskname + "</td>";
                html += "<td>" + data.status + "</td>";
                html += "<td>" + data.duration + "</td>";
                html += "<td></td>";
                html += "</tr>";*/
                $("#task_list").append(html);

                //关闭弹窗
                $("#myModal2").modal("hide");
            },
            error: function (data) {
                alert("任务添加失败！");
            }
        });
    }


    /**
     * 修改当前任务的音量和模式
     */
    function update_task_volume(){
        var task = $("[alt='del']")[0];
        if(!task){
            alert("请选中需要修改的任务！");
            return;
        }

        var tid = task.getAttribute("taskidstr");

        //获得循环类型
        var loopType = $("input[name='looptype'][type='radio']:checked").val();
        //获得音量
        var volume = $("#volume input").val();

        //ajax提交任务
        $.ajax({
            type: "POST",
            url: [[${#request.getContextPath()}]] + '/web/task/updateVolume',
            data: {
                "looptype": loopType,
                "volume": volume,
                "taskt": 5,
                "taskid": tid
            },
            success: function (data) {
                //发送websocket
                console.log(data);

                alert("修改成功！");
            },
            error: function (data) {
            }
        });
    }

</script>

</body>
</html>